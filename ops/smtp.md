# Өзүңүздүн SMTP почта жөнөтүүчү сервериңизди түзүңүз

## преамбула

SMTP түздөн-түз булут сатуучулардан кызматтарды сатып алат, мисалы:

* [Amazon SES SMTP](https://docs.aws.amazon.com/ses/latest/dg/send-email-smtp.html)
* [Али булут электрондук почтасы](https://www.alibabacloud.com/help/directmail/latest/three-mail-sending-methods)

Сиз ошондой эле өзүңүздүн почта сервериңизди кура аласыз - чексиз жөнөтүү, жалпы баасы төмөн.

Төмөндө биз өзүбүздүн почта серверибизди кантип курууну этап-этабы менен көрсөтөбүз.

## Сервер тандоо

Өзүн-өзү жайгаштырылган SMTP сервери 25, 456 жана 587 ачык порттору бар коомдук IPди талап кылат.

Көбүнчө колдонулган коомдук булуттар демейки боюнча бул портторду жаап коюшкан жана аларды жумушка буйрук берүү менен ачуу мүмкүн болушу мүмкүн, бирок бул абдан түйшүктүү.

Мен бул порттору ачык жана тескери домендик аталыштарды орнотууну колдогон хосттон сатып алууну сунуштайм.

Бул жерде мен [Контабону](https://contabo.com) сунуштайм.

Contabo абдан атаандаштык баалар менен 2003-жылы негизделген Мюнхен, Германия, негизделген хостинг камсыздоочу болуп саналат.

Сатып алуу валютасы катары Еврону тандасаңыз, баасы арзаныраак болот (8 ГБ эс тутуму жана 4 CPU менен сервер жылына болжол менен 529 юань турат, ал эми алгачкы орнотуу акысы бир жыл бою акысыз).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/UoAQkwY.webp)

Заказ бергенде, `prefer AMD` белгилеңиз, жана AMD CPU менен сервер жакшыраак иштешине ээ болот.

Төмөндө мен өзүңүздүн почта сервериңизди кантип курууну көрсөтүү үчүн Контабонун VPSин мисал катары алам.

## Ubuntu тутумунун конфигурациясы

Бул жерде иштөө системасы Ubuntu 22.04

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/smpIu1F.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/m7Mwjwr.webp)

Эгерде ssh серверинде `Welcome to TinyCore 13!` (төмөндөгү сүрөттө көрсөтүлгөндөй), бул система али орното элек дегенди билдирет. Сураныч, sshти ажыратып, кайра кирүү үчүн бир нече мүнөт күтө туруңуз.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/-qKACz9.webp)

`Welcome to Ubuntu 22.04.1 LTS` билдирүү пайда болгондо, инициализация аяктады жана сиз төмөнкү кадамдарды уланта аласыз.

### [Кошумча] Өнүктүрүү чөйрөсүн баштаңыз

Бул кадам милдеттүү эмес.

Ыңгайлуу болуу үчүн, [github.com/wactax/ops.os/tree/main/ubuntu](https://github.com/wactax/ops.os/tree/main/ubuntu) дарегине Ubuntu программасын орнотууну жана системалык конфигурациясын койдум.

Бир чыкылдатуу менен орнотуу үчүн төмөнкү буйрукту иштетиңиз.

```
bash <(curl -s https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

Кытай колдонуучулары, анын ордуна төмөнкү буйрукту колдонуңуз, ошондо тил, убакыт алкагы ж.б. автоматтык түрдө орнотулат.

```
CN=1 bash <(curl -s https://ghproxy.com/https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

### Contabo IPV6ды иштетет

SMTP да IPV6 даректери менен электрондук каттарды жөнөтө алышы үчүн IPV6 иштетиңиз.

түзөтүү `/etc/sysctl.conf`

Төмөнкү саптарды өзгөртүңүз же кошуңуз

```
net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0
```

[Контабо үйрөткүчү менен улантыңыз: IPv6 байланышын сервериңизге кошуу](https://contabo.com/blog/adding-ipv6-connectivity-to-your-server/)

`/etc/netplan/01-netcfg.yaml` түзөтүңүз, төмөндөгү сүрөттө көрсөтүлгөндөй бир нече саптарды кошуңуз (Contabo VPS демейки конфигурация файлында бул саптар бар, жөн гана аларга комментарий калтырыңыз).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/5MEi41I.webp)

Андан кийин `netplan apply` .

Конфигурация ийгиликтүү аяктагандан кийин, тышкы тармагыңыздын ipv6 дарегин көрүү үчүн `curl 6.ipw.cn` колдонсоңуз болот.

## Конфигурация репозиторийинин операцияларын клондоштуруу

```
git clone https://github.com/wactax/ops.soft.git
```

## Домен атыңыз үчүн акысыз SSL сертификатын түзүңүз

Почта жөнөтүү шифрлөө жана кол коюу үчүн SSL сертификатын талап кылат.

Биз сертификаттарды түзүү үчүн [acme.sh](https://github.com/acmesh-official/acme.sh) колдонобуз.

acme.sh ачык булактуу автоматташтырылган сертификатка кол коюу куралы,

Конфигурация кампасына ops.soft кириңиз, `./ssl.sh` иштетиңиз жана **жогорку каталогдо** `conf` папкасы түзүлөт.

[Acme.sh dnsapi](https://github.com/acmesh-official/acme.sh/wiki/dnsapi) сайтынан DNS провайдериңизди табыңыз, `conf/conf.sh` түзөтүңүз.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Qjq1C1i.webp)

Андан кийин домен атыңыз үчүн `123.com` жана `*.123.com` сертификаттарын түзүү үчүн `./ssl.sh 123.com` иштетиңиз.

Биринчи иштетүү [acme.shти](https://github.com/acmesh-official/acme.sh) автоматтык түрдө орнотуп, автоматтык түрдө жаңыртуу үчүн пландаштырылган тапшырманы кошот. Сиз `crontab -l` көрө аласыз, төмөнкүдөй сызык бар.

```
52 0 * * * "/mnt/www/.acme.sh"/acme.sh --cron --home "/mnt/www/.acme.sh" > /dev/null
```

Түзүлгөн сертификаттын жолу `/mnt/www/.acme.sh/123.com_ecc。`

Сертификатты жаңыртуу `conf/reload/123.com.sh` скриптин чакырат, бул скриптти түзөтөт, тиешелүү колдонмолордун сертификат кэшин жаңылоо үчүн `nginx -s reload` сыяктуу буйруктарды кошо аласыз.

## Chasquid менен SMTP серверин куруңуз

[chasquid](https://github.com/albertito/chasquid) Go тилинде жазылган ачык булак SMTP сервери.

Postfix жана Sendmail сыяктуу байыркы почта серверинин программаларын алмаштыруучу chasquid жөнөкөй жана колдонууга оңой, ошондой эле экинчилик иштеп чыгуу үчүн да оңой.

Run `./chasquid/init.sh 123.com` бир чыкылдатуу менен автоматтык түрдө орнотулат (123.com дегенди жөнөтүүчү домен атыңыз менен алмаштырыңыз).

## DKIM электрондук почта кол тамгасын конфигурациялоо

DKIM каттардын спам катары каралышынын алдын алуу үчүн электрондук кол тамгаларды жөнөтүү үчүн колдонулат.

Буйрук ийгиликтүү иштегенден кийин, сизден DKIM жазуусун орнотуу сунушталат (төмөндө көрсөтүлгөндөй).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/LJWGsmI.webp)

Жөн гана DNSке TXT жазуусун кошуңуз (төмөндө көрсөтүлгөндөй).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/0szKWqV.webp)

## Кызмат абалын жана журналдарын көрүү

 `systemctl status chasquid` Кызмат абалын көрүү.

Нормалдуу иштөө абалы төмөндөгү сүрөттө көрсөтүлгөн

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/CAwyY4E.webp)

 `grep chasquid /var/log/syslog` же `journalctl -xeu chasquid` каталар журналын көрө алат.

## Тескери домендик аталыштын конфигурациясы

Тескери домендик аталыш IP дарегин тиешелүү домендик атка чечүүгө мүмкүндүк берет.

Тескери домендик аталышты коюу электрондук каттарды спам катары аныктоодон сактайт.

Почта келип түшкөндө, кабыл алуучу сервер жөнөтүүчү сервердин жарактуу тескери домендик аталышы бар же жок экендигин тастыктоо үчүн жөнөтүүчү сервердин IP дарегине тескери домендик аталышты талдоо жүргүзөт.

Эгерде жөнөтүүчү серверде тескери домен аты жок болсо же тескери домен аты жөнөтүүчү сервердин IP дарегине дал келбесе, кабыл алуучу сервер электрондук катты спам катары таанып же аны четке кагышы мүмкүн.

[https://my.contabo.com/rdns](https://my.contabo.com/rdns) дарегине кирип, төмөндө көрсөтүлгөндөй конфигурациялаңыз

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/IIPdBk_.webp)

Тескери домендик аталышты орноткондон кийин, IPv4 жана ipv6 домендик аталышынын серверге карай резолюциясын конфигурациялоону унутпаңыз.

## chasquid.conf хостунун атын түзөтүңүз

`conf/chasquid/chasquid.conf` тескери домендик аталыштын маанисине өзгөртүү.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/6Fw4SQi.webp)

Андан кийин кызматты кайра иштетүү үчүн `systemctl restart chasquid` иштетиңиз.

## Git репозиторийине камдык конф

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Fier9uv.webp)

Мисалы, мен conf папкасынын камдык көчүрмөсүн өзүмдүн github процессиме төмөнкүдөй жасайм

Алгач жеке кампа түзүңүз

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ZSCT1t1.webp)

conf каталогуна кирип, кампага тапшырыңыз

```
git init
git add .
git commit -m "init"
git branch -M main
git remote add origin git@github.com:wac-tax-key/conf.git
git push -u origin main
```

## Жөнөтүүчү кошуу

чуркоо

```
chasquid-util user-add i@wac.tax
```

Жөнөтүүчүнү кошо алат

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/khHjLof.webp)

### Сырсөз туура коюлганын текшериңиз

```
chasquid-util authenticate i@wac.tax --password=xxxxxxx
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/e92JHXq.webp)

Колдонуучуну кошкондон кийин, `chasquid/domains/wac.tax/users` жаңыланат, аны кампага тапшырууну унутпаңыз.

## DNS SPF жазуусун кошот

SPF (Sender Policy Framework) электрондук почта алдамчылыгын алдын алуу үчүн колдонулган электрондук почтаны текшерүү технологиясы.

Ал жөнөтүүчүнүн IP дареги ал ырастаган домендик аталыштын DNS жазууларына дал келээрин текшерүү аркылуу почта жөнөтүүчүнүн инсандыгын текшерип, алдамчылардын жалган каттарды жөнөтүүсүнө жол бербейт.

SPF жазууларын кошуу электрондук каттарды мүмкүн болушунча спам катары аныктоодон сактайт.

Эгерде сиздин домендик аталыш сервериңиз SPF түрүн колдоого албаса, жөн гана TXT түрүндөгү жазууну кошуңуз.

Мисалы, `wac.tax` SPF төмөнкүдөй

`v=spf1 a mx include:_spf.wac.tax include:_spf.google.com ~all`

`_spf.wac.tax` үчүн SPF

`v=spf1 a:smtp.wac.tax ~all`

Бул жерде менде `include:_spf.google.com` экенин эске алыңыз, анткени мен `i@wac.tax` дарегин Google почта кутусуна жөнөтүүчү дарек катары кийинчерээк конфигурациялайм.

## DNS конфигурациясы DMARC

DMARC (Domain-based Message Authentication, Reporting & Conformance) аббревиатурасы.

Ал SPF секирүүлөрүн тартуу үчүн колдонулат (мүмкүн конфигурация каталарынан улам келип чыгышы мүмкүн же кимдир бирөө спам жөнөтүү үчүн сизди көрсөтүп жатат).

TXT жазуусун кошуу `_dmarc` ,

мазмуну төмөнкүдөй

```
v=DMARC1; p=quarantine; fo=1; ruf=mailto:ruf@wac.tax; rua=mailto:rua@wac.tax
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/k44P7O3.webp)

Ар бир параметрдин мааниси төмөнкүдөй

### p (Саясат)

SPF (Sender Policy Framework) же DKIM (DomainKeys Identified Mail) текшерүүсүнөн өтпөй калган электрондук каттарды кантип иштетүү керектигин көрсөтөт. p параметрин үч маанинин бирине коюуга болот:

* эч ким: Эч кандай чара көрүлбөйт, текшерүү натыйжасы гана электрондук почта билдирүү механизми аркылуу жөнөтүүчүгө кайтарылат.
* Карантин: Текшерүүдөн өтпөй калган катты спам папкасына салыңыз, бирок катты түздөн-түз четке какпайт.
* четке кагуу: текшерүүдөн өтпөй калган электрондук каттарды түз эле четке кагуу.

### fo (Катачылык параметрлери)

Отчет берүү механизми тарабынан кайтарылган маалыматтын көлөмүн көрсөтөт. Аны төмөнкү маанилердин бирине коюуга болот:

* 0: Бардык билдирүүлөр үчүн текшерүү натыйжаларын кабарлоо
* 1: Текшерүүдөн өтпөй калган билдирүүлөрдү гана кабарлаңыз
* г: Домендик аталышты текшерүү каталары жөнүндө гана кабарлаңыз
* s: SPF текшерүү каталарын гана кабарлайт
* l: DKIM текшерүү каталары жөнүндө гана кабарлаңыз

### rua & ruf

* rua (Жыйналган отчеттор үчүн отчеттук URI): Бирдиктүү отчетторду алуу үчүн электрондук почта дареги
* ruf (Соттук экспертизалар үчүн отчеттук URI): толук отчетторду алуу үчүн электрондук почта дареги

## Электрондук каттарды Google Почтага багыттоо үчүн MX жазууларын кошуңуз

Мен универсалдуу даректерди колдогон акысыз корпоративдик почта кутусун таба албагандыктан (Catch-All, бул домендик атка жөнөтүлгөн электрондук каттарды префикстерге чектөөсүз ала алат), мен Gmail почта ящигиме бардык каттарды жөнөтүү үчүн chasquid колдондум.

**Эгер сиздин жеке акы төлөнүүчү бизнес почта ящигиңиз болсо, MXти өзгөртпөңүз жана бул кадамды өткөрүп жибербеңиз.**

`conf/chasquid/domains/wac.tax/aliases` түзөтүү, почта кутусун жөнөтүү

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/OBDl2gw.webp)

`*` бардык электрондук каттарды көрсөтөт, `i` жогоруда түзүлгөн жөнөтүүчү колдонуучунун электрондук почта дареги префикси. Почта жөнөтүү үчүн, ар бир колдонуучу сап кошуу керек.

Андан кийин MX жазуусун кошуңуз (мен төмөндөгү сүрөттө биринчи сапта көрсөтүлгөндөй, бул жерде тескери домендик аталыштын дарегин түз көрсөтөм).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/7__KrU8.webp)

Конфигурация аяктагандан кийин, Gmail'де электрондук каттарды ала аларыңызды билүү үчүн `i@wac.tax` жана `any123@wac.tax` даректерине электрондук каттарды жөнөтүү үчүн башка электрондук почта даректерин колдонсоңуз болот.

Болбосо, chasquid журналын текшериңиз ( `grep chasquid /var/log/syslog` ).

## Google Mail менен i@wac.tax дарегине электрондук кат жөнөтүңүз

Google Почта катты алгандан кийин, мен табигый түрдө i.wac.tax@gmail.com ордуна `i@wac.tax` менен жооп бергим келди.

[https://mail.google.com/mail/u/1/#settings/accounts](https://mail.google.com/mail/u/1/#settings/accounts) дарегине баш багыңыз жана "Башка электрондук почта дарегин кошуу" баскычын басыңыз.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/PAvyE3C.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/_OgLsPT.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/XIUf6Dc.webp)

Андан кийин, электрондук почтага жөнөтүлгөн текшерүү кодун киргизиңиз.

Акыр-аягы, аны жөнөтүүчүнүн демейки дареги катары коюуга болот (ошол эле дарек менен жооп берүү мүмкүнчүлүгү менен бирге).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/a95dO60.webp)

Ошентип, биз SMTP почта серверин түзүүнү аяктадык жана ошол эле учурда электрондук каттарды жөнөтүү жана кабыл алуу үчүн Google Mailди колдондук.

## Конфигурация ийгиликтүү болгонун текшерүү үчүн электрондук кат жөнөтүңүз

`ops/chasquid` киргизиңиз

Диренвди иштетүү көз карандылыкты орнотууга `direnv allow` (direnv мурунку бир ачкычты баштоо процессинде орнотулган жана кабыкка илгич кошулган)

анан чурка

```
user=i@wac.tax pass=xxxx to=iuser.link@gmail.com ./sendmail.coffee
```

Параметрлердин мааниси төмөнкүдөй

* колдонуучу: SMTP колдонуучу аты
* өтүү: SMTP сырсөз
* кимге: алуучуга

Сиз сыноо электрондук кат жөнөтө аласыз.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ae1iWyM.webp)

Конфигурациялардын ийгиликтүү болгонун текшерүү үчүн тесттик каттарды алуу үчүн Gmailди колдонуу сунушталат.

### TLS стандарттык шифрлөө

Төмөнкү сүрөттө көрсөтүлгөндөй, бул кичинекей кулпу бар, бул SSL сертификаты ийгиликтүү иштетилгенин билдирет.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/SrdbAwh.webp)

Андан кийин "Түпнуска электрондук почтаны көрсөтүү" баскычын чыкылдатыңыз

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/qQQsdxg.webp)

### DKIM

Төмөнкү сүрөттө көрсөтүлгөндөй, Gmail оригиналдуу почта барагында DKIM көрсөтүлөт, бул DKIM конфигурациясынын ийгиликтүү болгонун билдирет.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/an6aXK6.webp)

Түпнуска электрондук почтанын башындагы Кабыл алынганды текшериңиз жана жөнөтүүчүнүн дареги IPV6 экенин көрө аласыз, бул IPV6 да ийгиликтүү конфигурацияланганын билдирет.
